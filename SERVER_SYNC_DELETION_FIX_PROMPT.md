# Промпт для исправления синхронизации удалений на сервере

## Контекст

В мобильном приложении (Android, app-crm) при удалении сущностей (клиенты, группы клиентов, объекты, установки, компоненты) они правильно помечаются для удаления и отправляются на сервер через API `sync/push` в секции `deleted`. Однако после следующей синхронизации (`sync/pull`) эти удаленные сущности возвращаются обратно в приложение.

## Проблема

Удаленные сущности возвращаются после синхронизации, что означает одно из следующего:
1. Сервер не удаляет записи из базы данных при получении запроса на удаление
2. Сервер возвращает удаленные записи в ответе `sync/pull`
3. Сервер не обрабатывает секцию `deleted` в запросе `sync/push`

## Задача

Исправить обработку удалений на сервере так, чтобы:
1. При получении запроса `sync/push` с секцией `deleted` сервер удалял соответствующие записи из базы данных
2. При формировании ответа `sync/pull` сервер не возвращал удаленные записи
3. Удаленные записи больше не появлялись в приложении после синхронизации

## Формат данных

### Запрос sync/push

```json
{
  "deleted": [
    {
      "entity": "clients",  // или "client_groups", "sites", "installations", "components"
      "recordId": "uuid-сущности",
      "deletedAtEpoch": 1234567890
    }
  ],
  // ... другие данные синхронизации
}
```

### Ожидаемое поведение

1. **Обработка удалений в sync/push:**
   - Прочитать массив `deleted` из запроса
   - Для каждой записи найти соответствующую таблицу по полю `entity`
   - Удалить запись с `id = recordId` из базы данных
   - Логировать каждое удаление
   - Обработать ошибки (например, если запись уже удалена или не существует)

2. **Фильтрация в sync/pull:**
   - При выборке данных из БД исключить удаленные записи
   - Если используется soft delete (поле `deletedAtEpoch`), фильтровать записи где `deletedAtEpoch IS NULL`
   - Если используется hard delete, записи уже не должны быть в БД

## Сущности для обработки

Необходимо обработать следующие типы сущностей:

1. `clients` - клиенты
2. `client_groups` - группы клиентов
3. `sites` - объекты
4. `installations` - установки
5. `components` - компоненты

## Дополнительные требования

1. **Группы клиентов:**
   - При удалении группы клиентов клиенты из этой группы должны быть обработаны (перемещены в "без группы" или обработаны иначе, в зависимости от бизнес-логики)

2. **Логирование:**
   - Логировать все операции удаления
   - Логировать ошибки при удалении
   - Логировать случаи, когда запись не найдена

3. **Обработка ошибок:**
   - Если запись уже удалена - не возвращать ошибку (idempotent операция)
   - Если запись не найдена - логировать предупреждение, но не возвращать ошибку
   - Если произошла другая ошибка - логировать и вернуть ошибку клиенту

## Тестирование

После исправления проверить:

1. Удалить сущность в приложении
2. Выполнить синхронизацию push
3. Выполнить синхронизацию pull
4. Убедиться, что удаленная сущность не вернулась в приложение

## Дополнительная информация

Подробный отчет о проблеме находится в файле `SYNC_DELETION_ISSUES_REPORT.md`.

Код клиентской части для справки:
- `app-crm/src/main/java/com/example/wassertech/sync/SyncEngine.kt` - логика синхронизации
- `app-crm/src/main/java/com/example/wassertech/sync/SafeDeletionHelper.kt` - удаление сущностей
- `app-crm/src/main/java/com/example/wassertech/sync/DeletionTracker.kt` - отслеживание удалений

