# Отчёт о рефакторинге app-client

## Выполненные задачи

### 1. Созданы утилиты для проверки прав доступа
**Файл:** `app-client/src/main/java/com/example/wassertech/client/permissions/PermissionUtils.kt`

Созданы функции для проверки прав доступа:
- `canEditSite()` - проверка права редактирования объекта
- `canDeleteSite()` - проверка права удаления объекта
- `canEditInstallation()` - проверка права редактирования установки
- `canDeleteInstallation()` - проверка права удаления установки
- `canEditComponent()` - проверка права редактирования компонента
- `canDeleteComponent()` - проверка права удаления компонента
- `canEditTemplate()` - проверка права редактирования шаблона
- `canDeleteTemplate()` - проверка права удаления шаблона
- `canCreateEntity()` - проверка права создания сущностей
- `canGeneratePdf()` - проверка права генерации PDF (всегда false в app-client)
- `canViewPdf()` - проверка права просмотра PDF

**ВАЖНО:** В текущей реализации все функции возвращают `true` (кроме `canGeneratePdf()`), так как в схеме БД отсутствуют поля для различения CRM-данных от клиентских. Это временная реализация с TODO-комментариями.

### 2. Создан экран списка объектов (SitesScreen)
**Файл:** `app-client/src/main/java/com/example/wassertech/client/ui/sites/SitesScreen.kt`

Экран показывает список объектов текущего клиента с использованием компонентов из `core:ui`:
- `AppEmptyState` - для пустого состояния
- `EntityRowWithMenu` - для отображения строк объектов
- Стандартные Material3 компоненты для диалогов

**Особенности:**
- Показывает только объекты текущего клиента (фильтрация по `clientId`)
- Кнопка добавления объекта показывается только если `canCreateEntity()` возвращает `true`
- Кнопки редактирования/удаления показываются только если `canEditSite()` возвращает `true`
- Использует стандартные Material3 диалоги вместо `CommonAddDialog` (так как он не доступен в app-client)

## Недостающие данные и вопросы

### 1. Роль CLIENT отсутствует в UserRole
**Проблема:** В `core/auth/src/main/java/com/example/wassertech/core/auth/UserRole.kt` определены только роли:
- ADMIN
- USER
- VIEWER

Но нет роли CLIENT, которая нужна для app-client.

**Вопрос:** Нужно ли добавить роль CLIENT в enum UserRole? Или app-client использует одну из существующих ролей (например, USER)?

### 2. Отсутствует поле для различения CRM-данных от клиентских
**Проблема:** В сущностях (`SiteEntity`, `InstallationEntity`, `ComponentEntity`, `ComponentTemplateEntity`) отсутствуют поля, которые позволяют определить, была ли сущность создана инженером в CRM или клиентом в app-client.

**Требуемые поля:**
- `createdByUserId: String?` - ID пользователя, создавшего сущность
- ИЛИ `source: String` - источник создания ("CRM" или "CLIENT")
- ИЛИ `origin: String` - происхождение сущности
- ИЛИ `isClientOwned: Boolean` - флаг принадлежности клиенту

**Вопрос:** Какое поле/поля нужно добавить в сущности для различения CRM-данных от клиентских?

### 3. Связь между userId и clientId
**Проблема:** Неясно, как получить `clientId` текущего пользователя в app-client.

**Варианты:**
1. `clientId = userId` (ID пользователя равен ID клиента)
2. `clientId` хранится в настройках/токене
3. `clientId` получается из API при логине
4. В таблице `clients` есть запись с `id = userId`

**Вопрос:** Как получить `clientId` текущего пользователя в app-client?

### 4. Компоненты из app-crm/ui/common недоступны в app-client
**Проблема:** Компоненты `AppFloatingActionButton`, `CommonAddDialog` и другие из `app-crm/ui/common` не доступны в app-client.

**Решение:** 
- Временно используются стандартные Material3 компоненты
- Рекомендуется вынести общие компоненты в `core:ui` или создать локальные версии в app-client

## Оставшиеся задачи

### 1. Создать экран деталей объекта (SiteDetailScreen)
- Показывать список установок внутри объекта
- Ограничить редактирование/удаление установок на основе прав доступа
- Использовать компоненты из `core:ui`

### 2. Создать экран установок (ComponentsScreen)
- Показывать список компонентов установки
- Ограничить редактирование/удаление компонентов на основе прав доступа
- Скрыть кнопку "Провести ТО" (недоступна в app-client)
- Использовать компоненты из `core:ui`

### 3. Обновить навигацию app-client
- Добавить маршруты для новых экранов
- Обновить `AppNavigation.kt` и `AppRoutes.kt`

### 4. Обновить HomeScreen
- Изменить главный экран для показа списка объектов вместо только отчётов
- Добавить навигацию к объектам

### 5. Скрыть/отключить функционал генерации PDF
- Убедиться, что все кнопки/меню для генерации PDF скрыты в app-client
- Оставить возможность просмотра уже сгенерированных PDF (когда появится передача файлов)

## Использованные компоненты из core:ui

- `AppEmptyState` - для пустых состояний
- `EntityRowWithMenu` - для отображения строк сущностей
- `EmptyGroupPlaceholder` - для пустых групп (планируется использовать)
- `ScreenTitleWithSubtitle` - для заголовков экранов (планируется использовать)
- `ReorderableLazyColumn` - для drag-n-drop (планируется использовать, если клиент может менять порядок)

## Рекомендации

1. **Добавить роль CLIENT** в `UserRole` enum, если она нужна
2. **Добавить поля для различения CRM/CLIENT данных** в сущности
3. **Вынести общие UI-компоненты** (`AppFloatingActionButton`, `CommonAddDialog`) в `core:ui`
4. **Уточнить способ получения clientId** текущего пользователя
5. **Добавить миграцию БД** для новых полей в сущностях

## Следующие шаги

После получения ответов на вопросы о недостающих данных:
1. Обновить функции проверки прав в `PermissionUtils.kt`
2. Завершить создание экранов `SiteDetailScreen` и `ComponentsScreen`
3. Обновить навигацию и HomeScreen
4. Протестировать работу приложения

