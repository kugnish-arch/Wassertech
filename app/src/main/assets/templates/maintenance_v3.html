<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Акт ТО № {{doc.number}} от {{doc.date_rus}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
          --brand: #c0182c;        /* акцент как у Wassertech */
          --ink: #1f2328;
          --muted: #6b7280;
          --line: #e5e7eb;
        }
        @page { 
          size: A4; 
          margin: 10mm 10mm 10mm 10mm; /* поля по 1 см со всех сторон */
        }
        * { box-sizing: border-box; }
        html, body { 
          margin:0; 
          padding:0; 
          font-family: "Segoe UI Light", "Segoe UI", system-ui, -apple-system, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif; 
          color: var(--ink); 
          height: auto;
          min-height: auto;
        }
        body { 
          font-size: 12.5pt; 
          line-height: 1.36;
          overflow: visible;
        }

        /* Шапка - информация о компании слева, логотип справа */
        .header { 
          display: flex; 
          justify-content: space-between; 
          align-items: flex-start; 
          margin-bottom: 10mm; 
        }
        .requisites { 
          font-size: 11.5pt; 
          flex: 1; 
          max-width: calc(100% - 280px);
          padding-left: 4mm;
          padding-top: 0;
          margin-top: 0;
        }
        .requisites b { font-weight: 600; }
        .requisites .muted { color: var(--muted); }
        .requisites .contacts { margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap; }
        .logo { 
          width: 240px; 
          height: 240px; 
          object-fit: contain; 
          flex-shrink: 0;
          margin-right: 4mm;
          padding-top: 0;
          margin-top: 0;
          align-self: flex-start;
        }

        /* Заголовок документа */
        .doc-title { text-align: center; margin: 0 0 8mm; }
        .doc-title h1 {
          font-size: 18.5pt; margin: 0 0 4mm; font-weight: 300;
        }
        .doc-title .subtitle { color: var(--muted); font-size: 12pt; }

        /* Инфоблоки */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 18px; margin-bottom: 8mm; }
        .grid .item { padding: 10px 12px; border: 1px solid var(--line); border-radius: 10px; background: #fff; }
        .item .label { font-size: 10.5pt; color: var(--muted); margin-bottom: 2px; }
        .item .value { font-size: 12.5pt; }

        /* Разделы */
        .section { margin: 0 0 8mm; }
        .section h2 {
          font-size: 13.5pt; margin: 0 0 6px;
          padding: 8px 10px; line-height: 1.2;
          border-left: 4px solid var(--brand); 
          padding-left: 10px; 
        }
        .section-header-red {
          font-size: 13.5pt;
          margin: 0 -16mm 6px -16mm;
          padding: 10px 16mm;
          padding-left: calc(16mm + 10px);
          background-color: var(--brand);
          color: white;
          line-height: 1.4;
          font-weight: 300;
        }
        .section p { margin: 6px 0; }
        .list { margin: 4px 0 0 0; padding-left: 18px; }
        .list li { margin: 2px 0; }

        /* Компоненты с полями */
        .components-grid {
          display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6mm; margin-top: 6px;
          align-items: start; /* Выравнивание по верху */
        }
        .component-card {
          margin-bottom: 0; border: 1px solid var(--line); border-radius: 8px;
          break-inside: avoid; 
          page-break-inside: avoid;
          -webkit-column-break-inside: avoid;
          min-height: auto; /* Автоматическая высота */
        }
        
        /* Предотвращаем разрыв компонентов между страницами */
        .component-header {
          break-after: avoid;
          page-break-after: avoid;
        }
        
        .component-fields {
          break-inside: avoid;
          page-break-inside: avoid;
        }
        /* Предотвращаем создание пустых страниц */
        body::after {
          display: none;
          content: "";
        }
        /* HEAD компоненты занимают всю строку */
        .component-card-head {
          grid-column: 1 / -1;
        }
        .component-header {
          background: #f9fafb; padding: 10px 14px; border-bottom: 1px solid var(--line);
        }
        .component-header h3 {
          font-size: 13pt; margin: 0; font-weight: 600;
        }
        .component-fields {
          padding: 8px 12px;
        }
        .field-row {
          display: grid; grid-template-columns: 2fr 1fr; gap: 8px; padding: 3px 0;
          border-bottom: 1px solid #f3f4f6;
        }
        .field-row:last-child { border-bottom: none; }
        .field-label {
          font-size: 9pt; color: var(--muted);
        }
        .field-value {
          font-size: 9.5pt; font-weight: 500; text-align: right;
          display: flex; align-items: center; justify-content: flex-end; gap: 4px;
        }
        .field-value .unit {
          font-size: 8.5pt; color: var(--muted); font-weight: normal; margin-left: 4px;
        }
        /* Стили для чекбоксов */
        .field-value.checkbox-yes {
          color: #dc2626; font-weight: 600;
        }
        .field-value.checkbox-yes::before {
          content: "✕"; color: #dc2626; font-size: 11pt; margin-right: 2px;
        }
        .field-value.checkbox-no {
          color: #16a34a; font-weight: 600;
        }
        .field-value.checkbox-no::before {
          content: "✓"; color: #16a34a; font-size: 11pt; margin-right: 2px;
        }

        /* Таблица анализов */
        table {
          width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 12pt;
        }
        th, td {
          border: 1px solid var(--line); padding: 8px 10px; vertical-align: top;
        }
        th { background: #fafafa; text-align: left; font-weight: 600; }

        /* Подписи - справа */
        .sign-row { 
          display: flex; 
          justify-content: flex-end; 
          margin-top: 14mm; 
          position: relative;
          page-break-inside: avoid;
        }
        .sign-container { 
          display: flex; 
          flex-direction: column; 
          align-items: flex-end;
          position: relative;
          width: 80mm;
          height: 50mm;
        }
        .sign-name {
          font-size: 11pt;
          font-weight: 600;
          font-family: "Segoe UI Light", "Segoe UI", system-ui, -apple-system, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
          position: absolute;
          bottom: 18mm;
          right: 0;
          padding-right: 8mm;
          z-index: 0;
          white-space: nowrap;
          color: var(--ink);
        }
        .sign-name .underline-space {
          display: inline-block;
          min-width: 40mm;
          border-bottom: 1px solid var(--ink);
          margin: 0 2mm;
          vertical-align: baseline;
        }
        .signature-image {
          position: absolute;
          bottom: 11mm;
          right: 15mm;
          max-width: 60mm;
          max-height: 25mm;
          object-fit: contain;
          z-index: 1;
          pointer-events: none;
        }
        .stamp-image {
          position: absolute;
          bottom: -5mm;
          right: 5mm;
          width: 42mm;
          height: 42mm;
          object-fit: contain;
          z-index: 2;
          pointer-events: none;
        }
        
        /* Колонтитул с номером страницы */
        .page-footer {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          height: 15mm;
          display: flex;
          align-items: center;
          justify-content: flex-end;
          padding-right: 16mm;
          padding-bottom: 2mm;
          font-size: 10pt;
          color: var(--muted);
          font-family: "Segoe UI Light", "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
          z-index: 1000;
        }
        
        /* Разделы для заглавных компонентов */
        .head-components-section {
          margin: 0 0 8mm;
        }
        
        /* Компонент без заголовка (первый заглавный компонент в разделе) */
        .component-card-no-header .component-header {
          display: none;
        }
        
        /* Блок "Продолжение отчёта" */
        .continuation-notice {
          text-align: center;
          padding: 8mm 0;
          color: var(--muted);
          font-size: 11pt;
          font-style: italic;
          page-break-inside: avoid;
        }
    </style>
</head>
<body>

<!-- ШАПКА -->
<header class="header">
    <div class="requisites">
        <div><b>{{company.legal_name}}</b>, ИНН {{company.inn}}</div>
        <div class="contacts">
            <span>+7 {{company.phone1}}</span>
            <span class="muted">{{company.email}}</span>
            <span class="muted">{{company.website}}</span>
        </div>
    </div>
    <img class="logo" src="{{company.logo_data_uri}}" alt="Логотип" />
</header>

<!-- ЗАГОЛОВОК -->
<section class="doc-title">
    <h1>Акт ТО № {{doc.number}} от {{doc.date_rus}}</h1>
    <div class="subtitle">по договору № {{contract.number}} от {{contract.date_rus}}</div>
</section>

<!-- ИНФОБЛОКИ -->
<section class="grid">
    <div class="item">
        <div class="label">Заказчик</div>
        <div class="value">{{client.name}}</div>
    </div>
    <div class="item">
        <div class="label">Объект</div>
        <div class="value">{{site.name}}</div>
    </div>
    <div class="item">
        <div class="label">Установка</div>
        <div class="value">{{installation.name}}</div>
    </div>
    <div class="item">
        <div class="label">Дата обслуживания</div>
        <div class="value">{{doc.date_rus}}</div>
    </div>
</section>

<!-- ВЫПОЛНЕННЫЕ РАБОТЫ -->
<section class="section">
    <h2 class="section-header-red">Выполненные работы</h2>
    <ul class="list">
        {{#works}}
        <li>{{.}}</li>
        {{/works}}

    </ul>
</section>

<!-- КОМПОНЕНТЫ С ПОЛЯМИ -->
<!-- Разделы компонентов генерируются в HtmlTemplateEngine -->
{{#componentsWithFields}}
{{#component}}
<div class="component-card">
    <div class="component-header">
        <h3>{{component.name}}</h3>
    </div>
    <div class="component-fields">
        {{#fields}}
        <div class="field-row">
            <div class="field-label">{{field.label}}</div>
            <div class="field-value{{field.checkboxClass}}">
                {{field.value}}{{#field.unit}} <span class="unit">{{field.unit}}</span>{{/field.unit}}
            </div>
        </div>
        {{/fields}}
    </div>
</div>
{{/component}}
{{/componentsWithFields}}

<!-- КОММЕНТАРИИ / ВЫЯВЛЕННЫЕ НЕДОСТАТКИ -->
{{#comments}}
<section class="section">
    <h2>Дополнительные комментарии и замечания</h2>
    <p>{{comments}}</p>
</section>
{{/comments}}

<!-- РЕЗУЛЬТАТЫ АНАЛИЗОВ -->
{{#water}}
<section class="section">
    <h2>Результаты анализов воды</h2>
    <table>
        <thead>
        <tr>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Ед. изм.</th>
            <th>Норма (при наличии)</th>
        </tr>
        </thead>
        <tbody>

        <tr>
            <td>{{name}}</td>
            <td>{{value}}</td>
            <td>{{unit}}</td>
            <td>{{norm}}</td>
        </tr>

        </tbody>
    </table>
</section>
{{/water}}

<!-- ИТОГОВАЯ ФОРМУЛИРОВКА (опционально) -->
{{#conclusion}}
<section class="section">
    <h2>Заключение</h2>
    <p>{{conclusion}}</p>
</section>
{{/conclusion}}

<!-- ПОДПИСИ -->
<section class="sign-row">
    <div class="sign-container">
        <div class="sign-name">{{company.sign_name}}<span class="underline-space"></span>/{{company.sign_short}}/</div>
        <img class="signature-image" src="{{company.signature_data_uri}}" alt="Подпись" />
        <img class="stamp-image" src="{{company.stamp_data_uri}}" alt="Печать" />
    </div>
</section>

<!-- КОЛОНТИТУЛ -->
<!-- Колонтитул добавляется через Canvas в WebViewPdfExporter -->

</body>
</html>

